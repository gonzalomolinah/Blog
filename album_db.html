<!DOCTYPE HTML>
<html>
  <head>
    <title>Gonzalo - Álbum</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <link rel="stylesheet" href="assets/css/site.css" />
    <style>
      .muted { opacity: 0.75; font-size: 0.95rem; }
      .gallery-container { margin-top: 2rem; }
      .gallery-status {
        margin: 1rem 0 2rem;
        transition: opacity 0.3s ease;
      }
      .gallery-status.hidden {
        display: none;
      }
      .gallery-status.error {
        color: #ff8a80;
      }
      .gallery-status.empty {
        padding: 1.75rem 1.25rem;
        border: 1px dashed var(--border);
        border-radius: 14px;
        text-align: center;
        color: rgba(255, 255, 255, 0.8);
        background: rgba(0, 0, 0, 0.2);
      }
      .gallery-grid {
        display: grid;
        gap: 1.75rem;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      }
      .card {
        background: var(--surface);
        border-radius: 16px;
        border: 1px solid var(--border);
        overflow: hidden;
        box-shadow: 0 24px 44px rgba(0, 0, 0, 0.35);
        transition: transform 0.25s ease, box-shadow 0.25s ease;
      }
      .card:hover {
        transform: translateY(-6px);
        box-shadow: 0 32px 56px rgba(0, 0, 0, 0.45);
      }
      .card figure {
        margin: 0;
        display: flex;
        flex-direction: column;
        height: 100%;
      }
      .card img {
        width: 100%;
        height: auto;
        display: block;
        border-radius: 0;
      }
      .card a {
        border-bottom: none;
      }
      .card figcaption {
        padding: 1.1rem 1.35rem;
        border-top: 1px solid var(--border);
        font-size: 1rem;
        min-height: 3rem;
        display: flex;
        align-items: center;
        letter-spacing: 0.03em;
      }
      .card figcaption span {
        opacity: 0.85;
      }
      @media (max-width: 640px) {
        .gallery-grid {
          grid-template-columns: 1fr;
        }
        .card figcaption {
          font-size: 0.95rem;
        }
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      // TODO: Rellena con tus credenciales
      const SUPABASE_URL = "https://qrymkghhwejkbvsrvkht.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFyeW1rZ2hod2Vqa2J2c3J2a2h0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MDM1MDYsImV4cCI6MjA3NjE3OTUwNn0.CJVE12mhbwogRhjV1fcEdB-2D_2gQOT6fZbeRAEagJE";
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    </script>
  </head>
  <body>
    <div id="page-wrapper">
      <header id="header">
        <h1><a href="index.html">Gonzalo Molina</a></h1>
        <nav><a href="#menu">Menú</a></nav>
      </header>

      <nav id="menu">
        <div class="inner">
          <h2>Menu</h2>
          <ul class="links">
            <li><a href="index.html">Home</a></li>
            <li><a href="album.html">Álbum</a></li>
            <li><a href="admin.html">Iniciar sesión</a></li>
            <li><a href="contact.html">Contacto</a></li>
          </ul>
          <a href="#" class="close">Close</a>
        </div>
      </nav>

      <section id="banner" class="banner-alt">
        <div class="inner">
          <div class="logo"><span class="icon fa-camera"></span></div>
          <h2>Álbum</h2>
          <p>Se carga dinámicamente desde Supabase</p>
        </div>
      </section>

      <section id="wrapper">
        <section class="wrapper style1">
          <div class="inner">
            <h2 class="major">Galería</h2>
            <p class="muted">Las imágenes se optimizan vía la CDN de Supabase (<code>?width=1200&amp;quality=80</code>).</p>
            <div class="gallery-container">
              <p id="gallery-status" class="gallery-status muted">Cargando álbum...</p>
              <div id="gallery" class="gallery-grid" role="list"></div>
            </div>
          </div>
        </section>
      </section>

      <section id="footer">
        <div class="inner">
          <h2 class="major">Contacto y Redes</h2>
          <ul class="contact">
            <li class="icon solid fa-envelope"><a href="mailto:yo@gonzalomolina.space">yo@gonzalomolina.space</a></li>
            <li class="icon brands fa-instagram"><a href="https://instagram.com/gonzalomolinah">@gonzalomolinah</a></li>
          </ul>
          <ul class="copyright">
            <li>&copy; Desarrollada por <a href="https://github.com/gonzalomolinah">Gonzalo Molina</a>. Todos los derechos reservados.</li>
            <li>Diseño/Design: <a href="http://html5up.net">HTML5 UP</a></li>
          </ul>
        </div>
      </section>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const gallery = document.getElementById('gallery');
        const status = document.getElementById('gallery-status');
        const FALLBACK_IMG = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
        if (gallery) {
          gallery.setAttribute('aria-live', 'polite');
        } else {
          return;
        }

        function setStatus(message, variant = 'info') {
          if (!status) return;
          status.textContent = message || '';
          status.className = 'gallery-status';
          if (!message) {
            status.classList.add('hidden');
            return;
          }
          if (variant === 'error') {
            status.classList.add('error');
          } else if (variant === 'empty') {
            status.classList.add('empty');
          } else {
            status.classList.add('muted');
          }
        }

        function parseStoragePath(path) {
          const safePath = (path || '').replace(/^\/+/, '');
          const parts = safePath.split('/');
          const bucket = parts.shift();
          return { bucket, objectPath: parts.join('/') };
        }

        function getImageUrl(path, transform) {
          const { bucket, objectPath } = parseStoragePath(path);
          if (!bucket || !objectPath) return '';
          const { data, error } = supabase.storage.from(bucket).getPublicUrl(
            objectPath,
            transform ? { transform } : undefined
          );
          if (error) {
            console.warn('No se pudo generar la URL pública para', path, error);
            return '';
          }
          return data && data.publicUrl ? data.publicUrl : '';
        }

        function renderGallery(photos) {
          gallery.innerHTML = '';
          if (!photos.length) {
            gallery.classList.add('is-empty');
            setStatus('Todavía no hay fotos publicadas. Vuelve pronto ✨', 'empty');
            return;
          }
          gallery.classList.remove('is-empty');
          const fragment = document.createDocumentFragment();
          photos.forEach(photo => {
            const article = document.createElement('article');
            article.className = 'card';
            article.setAttribute('role', 'listitem');

            const figure = document.createElement('figure');

            const fullUrl = getImageUrl(photo.path);
            const displayUrl = getImageUrl(photo.path, { width: 1200, quality: 80 });
            const effectiveUrl = displayUrl || fullUrl || FALLBACK_IMG;

            const link = document.createElement('a');
            if (fullUrl || displayUrl) {
              link.href = fullUrl || displayUrl;
              link.target = '_blank';
              link.rel = 'noopener';
            } else {
              link.href = '#';
            }

            const titleRaw = photo.title && photo.title.trim();
            const img = document.createElement('img');
            img.src = effectiveUrl;
            img.alt = titleRaw || 'Fotografía del álbum';
            img.loading = 'lazy';

            link.appendChild(img);
            figure.appendChild(link);

            const caption = document.createElement('figcaption');
            caption.className = 'meta';
            const captionSpan = document.createElement('span');
            captionSpan.textContent = titleRaw || 'Sin título';
            caption.appendChild(captionSpan);
            figure.appendChild(caption);

            article.appendChild(figure);
            fragment.appendChild(article);
          });
          gallery.appendChild(fragment);
          setStatus('', 'info');
        }

        async function loadAlbum() {
          setStatus('Cargando álbum...', 'info');
          try {
            const { data, error } = await supabase
              .from('album_photos')
              .select('*')
              .order('position', { ascending: true })
              .order('created_at', { ascending: true });
            if (error) throw error;
            renderGallery(data || []);
          } catch (error) {
            console.error(error);
            gallery.innerHTML = '';
            setStatus(error.message || 'No se pudo cargar el álbum. Intenta nuevamente más tarde.', 'error');
          }
        }

        loadAlbum();
      });
    </script>

    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/jquery.scrollex.min.js"></script>
    <script src="assets/js/browser.min.js"></script>
    <script src="assets/js/breakpoints.min.js"></script>
    <script src="assets/js/util.js"></script>
    <script src="assets/js/main.js"></script>
  </body>
</html>
