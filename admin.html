<!DOCTYPE HTML>
<html>
  <head>
    <title>Gonzalo - Admin Álbum</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <link rel="stylesheet" href="assets/css/site.css" />
    <style>
      .muted { opacity: 0.75; font-size: 0.95rem; }
      .admin-panel {
        max-width: 1080px;
        margin: 3rem auto;
        padding: 2.5rem;
        background: var(--surface);
        border-radius: 16px;
        border: 1px solid var(--border);
        box-shadow: 0 24px 48px rgba(0, 0, 0, 0.3);
      }
      .admin-panel h3 {
        margin-top: 0;
        margin-bottom: 1.5rem;
      }
      .admin-toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: center;
      }
      .admin-toolbar form {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.5rem;
      }
      .admin-toolbar input[type="email"],
      .admin-toolbar input[type="password"] {
        background: rgba(0, 0, 0, 0.35);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 0.55rem 0.75rem;
        color: var(--text);
        min-width: 220px;
      }
      .admin-toolbar input[type="email"]:disabled,
      .admin-toolbar input[type="password"]:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .admin-status {
        margin-left: auto;
        min-height: 1.2em;
      }
      .status-ok { color: #8be1ae; }
      .status-error { color: #ff8a80; }
      .admin-upload {
        margin-top: 2rem;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.75rem;
      }
      .admin-upload input[type="file"] {
        padding: 0.85rem 1rem;
        border: 1px dashed var(--border);
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.2);
        color: var(--text);
        cursor: pointer;
      }
      .admin-upload input[type="file"]:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.8rem;
        letter-spacing: 0.08em;
        padding: 0.35rem 0.85rem;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(155, 241, 255, 0.18);
        text-transform: uppercase;
      }
      .admin-gallery {
        margin-top: 2rem;
      }
      .admin-gallery ul {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 1rem;
      }
      .admin-gallery ul.disabled {
        opacity: 0.5;
        pointer-events: none;
      }
      .admin-gallery li {
        background: rgba(0, 0, 0, 0.25);
        border-radius: 14px;
        border: 1px solid var(--border);
        padding: 0.85rem;
        cursor: grab;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .admin-gallery li:active {
        cursor: grabbing;
      }
      .admin-gallery li.dragging {
        opacity: 0.55;
        transform: scale(0.98);
        box-shadow: 0 16px 28px rgba(0, 0, 0, 0.35);
      }
      .admin-row {
        display: grid;
        grid-template-columns: auto minmax(160px, 1fr) auto auto auto;
        align-items: center;
        gap: 0.75rem;
      }
      .admin-row img {
        width: 96px;
        height: 96px;
        object-fit: cover;
        border-radius: 10px;
        border: 1px solid var(--border);
      }
      .admin-row input.title {
        background: rgba(0, 0, 0, 0.35);
        border: 1px solid var(--border);
        border-radius: 9px;
        padding: 0.6rem 0.75rem;
        color: var(--text);
        width: 100%;
      }
      .admin-row input.title:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .admin-row .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
        font-size: 0.85rem;
        opacity: 0.7;
      }
      .admin-row button.button {
        white-space: nowrap;
      }
      .admin-row button.button.danger {
        background: rgba(198, 40, 40, 0.85);
        border-color: rgba(198, 40, 40, 0.45);
      }
      .admin-row button.button:disabled {
        opacity: 0.55;
        cursor: not-allowed;
      }
      .admin-gallery-empty {
        padding: 2rem 1rem;
        text-align: center;
        border: 1px dashed var(--border);
        border-radius: 12px;
        color: rgba(255, 255, 255, 0.75);
      }
      .helper-text {
        margin-top: 0.5rem;
      }
      @media (max-width: 980px) {
        .admin-panel {
          padding: 2rem;
        }
        .admin-row {
          grid-template-columns: auto minmax(120px, 1fr) auto;
          grid-template-areas:
            "thumb title title"
            "thumb info actions";
        }
      }
      @media (max-width: 720px) {
        .admin-panel {
          padding: 1.75rem;
        }
        .admin-toolbar {
          flex-direction: column;
          align-items: stretch;
        }
        .admin-toolbar form,
        .admin-toolbar button,
        .admin-upload {
          width: 100%;
        }
        .admin-status {
          margin-left: 0;
        }
        .admin-row {
          grid-template-columns: minmax(0, 1fr);
          text-align: center;
        }
        .admin-row img {
          justify-self: center;
        }
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      // TODO: Rellena con tus credenciales
      const SUPABASE_URL = "https://qrymkghhwejkbvsrvkht.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFyeW1rZ2hod2Vqa2J2c3J2a2h0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MDM1MDYsImV4cCI6MjA3NjE3OTUwNn0.CJVE12mhbwogRhjV1fcEdB-2D_2gQOT6fZbeRAEagJE";
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    </script>
  </head>
  <body>
    <div id="page-wrapper">
      <header id="header">
        <h1><a href="index.html">Gonzalo Molina</a></h1>
        <nav><a href="#menu">Menú</a></nav>
      </header>

      <nav id="menu">
        <div class="inner">
          <h2>Menu</h2>
          <ul class="links">
            <li><a href="index.html">Home</a></li>
            <li><a href="album.html">Álbum</a></li>
            <li><a href="admin.html">Admin</a></li>
            <li><a href="contact.html">Contacto</a></li>
          </ul>
          <a href="#" class="close">Close</a>
        </div>
      </nav>

      <section id="banner" class="banner-alt">
        <div class="inner">
          <div class="logo"><span class="icon fa-lock"></span></div>
          <h2>Panel Admin Álbum</h2>
          <p>Login, subir, reordenar y borrar fotos</p>
        </div>
      </section>

      <section id="wrapper">
        <section class="wrapper style1">
          <div class="inner">
            <div class="admin-panel">
              <h3 class="major">Gestión del Álbum</h3>
              <div class="admin-toolbar">
                <button id="login-google" class="button primary small"><i class="fab fa-google"></i> Entrar con Google</button>
                <form id="login-email">
                  <input name="email" type="email" placeholder="Email" required />
                  <input name="password" type="password" placeholder="Password" required />
                  <button class="button small" type="submit">Entrar</button>
                </form>
                <button id="logout" class="button small" style="display:none"><i class="fas fa-sign-out-alt"></i> Salir</button>
                <span id="status" class="admin-status muted"></span>
              </div>

              <div class="admin-upload">
                <span class="badge"><i class="fas fa-user-shield"></i> Solo administradores</span>
                <input id="file" type="file" multiple accept="image/*" disabled />
                <button id="upload" class="button small" type="button" disabled>Subir</button>
              </div>

              <p id="admin-hint" class="muted helper-text"></p>

              <div class="admin-gallery">
                <ul id="list"></ul>
                <p id="reorder-hint" class="muted helper-text">Arrastra para reordenar. Se guarda automáticamente.</p>
              </div>
            </div>
          </div>
        </section>
      </section>

      <section id="footer">
        <div class="inner">
          <h2 class="major">Contacto y Redes</h2>
          <p class="muted">Volver al <a href="album.html">álbum</a>.</p>
        </div>
      </section>
    </div>

    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/jquery.scrollex.min.js"></script>
    <script src="assets/js/browser.min.js"></script>
    <script src="assets/js/breakpoints.min.js"></script>
    <script src="assets/js/util.js"></script>
    <script src="assets/js/main.js"></script>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const state = { session: null, admin: false, photos: [] };
        const elements = {
          loginGoogle: document.getElementById('login-google'),
          loginForm: document.getElementById('login-email'),
          logout: document.getElementById('logout'),
          status: document.getElementById('status'),
          fileInput: document.getElementById('file'),
          uploadButton: document.getElementById('upload'),
          list: document.getElementById('list'),
          adminHint: document.getElementById('admin-hint'),
          reorderHint: document.getElementById('reorder-hint')
        };
        let dragSource = null;

        function setStatus(message, type = 'info') {
          const el = elements.status;
          if (!el) return;
          el.textContent = message || '';
          el.classList.remove('status-ok', 'status-error', 'muted');
          if (!message) {
            el.classList.add('muted');
            return;
          }
          if (type === 'success') {
            el.classList.add('status-ok');
          } else if (type === 'error') {
            el.classList.add('status-error');
          } else {
            el.classList.add('muted');
          }
        }

        function parseStoragePath(path) {
          const safePath = (path || '').replace(/^\/+/, '');
          const parts = safePath.split('/');
          const bucket = parts.shift();
          return { bucket, objectPath: parts.join('/') };
        }

        function getImageUrl(path, transform) {
          const { bucket, objectPath } = parseStoragePath(path);
          if (!bucket || !objectPath) return '';
          const { data, error } = supabase.storage.from(bucket).getPublicUrl(
            objectPath,
            transform ? { transform } : undefined
          );
          if (error) {
            console.warn('No se pudo generar la URL pública para', path, error);
            return '';
          }
          return data && data.publicUrl ? data.publicUrl : '';
        }

        function updateUploadState() {
          const canAdmin = Boolean(state.session && state.admin);
          elements.uploadButton.disabled = !(canAdmin && elements.fileInput.files.length);
        }

        function updateAuthUI() {
          const hasSession = Boolean(state.session);
          const canAdmin = Boolean(state.session && state.admin);

          elements.loginGoogle.style.display = hasSession ? 'none' : 'inline-flex';
          elements.loginForm.style.display = hasSession ? 'none' : 'flex';
          elements.loginForm.querySelectorAll('input').forEach(input => {
            input.disabled = hasSession;
          });
          elements.logout.style.display = hasSession ? 'inline-flex' : 'none';

          elements.fileInput.disabled = !canAdmin;
          updateUploadState();

          elements.adminHint.textContent = canAdmin
            ? 'Tienes permisos completos para gestionar el álbum.'
            : 'Inicia sesión con una cuenta autorizada para subir, editar, reordenar o borrar fotos.';

          elements.list.classList.toggle('disabled', !canAdmin);
          elements.reorderHint.style.display = canAdmin && state.photos.length > 1 ? '' : 'none';

          elements.list.querySelectorAll('input.title').forEach(input => {
            input.disabled = !canAdmin;
          });
          elements.list.querySelectorAll('button').forEach(btn => {
            btn.disabled = !canAdmin;
          });
        }

        async function refreshPhotos(showFeedback = false) {
          try {
            if (showFeedback) setStatus('Cargando fotos...');
            const { data, error } = await supabase
              .from('album_photos')
              .select('*')
              .order('position', { ascending: true })
              .order('created_at', { ascending: true });
            if (error) throw error;
            state.photos = data || [];
            renderPhotos();
            if (showFeedback) setStatus(`Se cargaron ${state.photos.length} fotos.`, 'success');
          } catch (error) {
            state.photos = [];
            renderPhotos();
            setStatus(error.message || 'No se pudo cargar el álbum.', 'error');
          }
        }

        function renderPhotos() {
          const list = elements.list;
          list.innerHTML = '';
          if (!state.photos.length) {
            const empty = document.createElement('li');
            empty.className = 'admin-gallery-empty';
            empty.textContent = 'Todavía no hay fotos cargadas. Cuando subas imágenes aparecerán aquí.';
            list.appendChild(empty);
            updateAuthUI();
            return;
          }

          state.photos.forEach((photo, index) => {
            const li = document.createElement('li');
            li.dataset.id = photo.id;

            const row = document.createElement('div');
            row.className = 'admin-row';

            const img = document.createElement('img');
            img.alt = photo.title || `Foto ${index + 1}`;
            img.loading = 'lazy';
            const thumbUrl = getImageUrl(photo.path, { width: 360, quality: 70 });
            img.src = thumbUrl || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';

            const titleInput = document.createElement('input');
            titleInput.className = 'title';
            titleInput.value = photo.title != null ? photo.title : '';
            titleInput.placeholder = 'Título';

            const position = document.createElement('span');
            position.className = 'mono';
            const posNumber = Number.isFinite(photo.position) ? photo.position : index;
            position.textContent = `#${posNumber}`;

            const saveButton = document.createElement('button');
            saveButton.className = 'button small save';
            saveButton.type = 'button';
            saveButton.innerHTML = '<i class="fas fa-save"></i>';
            saveButton.title = 'Guardar título';
            saveButton.addEventListener('click', () => handleSave(photo.id, titleInput.value.trim()));

            const deleteButton = document.createElement('button');
            deleteButton.className = 'button small danger delete';
            deleteButton.type = 'button';
            deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i>';
            deleteButton.title = 'Borrar foto';
            deleteButton.addEventListener('click', () => handleDelete(photo.id));

            row.appendChild(img);
            row.appendChild(titleInput);
            row.appendChild(position);
            row.appendChild(saveButton);
            row.appendChild(deleteButton);
            li.appendChild(row);

            if (state.session && state.admin) {
              li.draggable = true;
              li.addEventListener('dragstart', () => {
                dragSource = li;
                li.classList.add('dragging');
              });
              li.addEventListener('dragend', () => {
                dragSource = null;
                li.classList.remove('dragging');
              });
              li.addEventListener('dragover', event => {
                event.preventDefault();
              });
              li.addEventListener('drop', event => {
                event.preventDefault();
                if (!dragSource || dragSource === li) return;
                const rect = li.getBoundingClientRect();
                const after = (event.clientY - rect.top) > rect.height / 2;
                elements.list.insertBefore(dragSource, after ? li.nextSibling : li);
                persistOrder();
              });
            }

            list.appendChild(li);
          });

          updateAuthUI();
        }

        async function handleSave(id, title) {
          if (!(state.session && state.admin)) {
            setStatus('No tienes permisos para guardar cambios.', 'error');
            return;
          }
          try {
            const { error } = await supabase.from('album_photos').update({ title }).eq('id', id);
            if (error) throw error;
            const match = state.photos.find(p => String(p.id) === String(id));
            if (match) match.title = title;
            setStatus('Título actualizado.', 'success');
          } catch (error) {
            setStatus(error.message || 'No se pudo actualizar el título.', 'error');
          }
        }

        async function handleDelete(id) {
          if (!(state.session && state.admin)) {
            setStatus('No tienes permisos para borrar fotos.', 'error');
            return;
          }
          const photo = state.photos.find(p => String(p.id) === String(id));
          if (!photo) {
            setStatus('No se encontró la foto seleccionada.', 'error');
            return;
          }
          if (!confirm('¿Borrar esta foto definitivamente?')) return;
          try {
            const { bucket, objectPath } = parseStoragePath(photo.path);
            if (bucket && objectPath) {
              const { error: storageError } = await supabase.storage.from(bucket).remove([objectPath]);
              if (storageError) throw storageError;
            }
            const { error } = await supabase.from('album_photos').delete().eq('id', id);
            if (error) throw error;
            setStatus('Foto borrada.', 'success');
            await refreshPhotos();
          } catch (error) {
            setStatus(error.message || 'No se pudo borrar la foto.', 'error');
          }
        }

        async function persistOrder() {
          if (!(state.session && state.admin)) return;
          const ordered = Array.from(elements.list.querySelectorAll('li'))
            .filter(item => item.dataset.id)
            .map((item, index) => ({ id: item.dataset.id, position: index }));
          if (!ordered.length) return;
          try {
            const { error } = await supabase.from('album_photos').upsert(ordered, { onConflict: 'id' });
            if (error) throw error;
            state.photos = ordered.map(({ id, position }) => {
              const current = state.photos.find(p => String(p.id) === String(id));
              return current ? { ...current, position } : null;
            }).filter(Boolean);
            renderPhotos();
            setStatus('Orden actualizado.', 'success');
          } catch (error) {
            setStatus(error.message || 'No se pudo guardar el nuevo orden.', 'error');
            await refreshPhotos();
          }
        }

        async function uploadPhotos() {
          if (!(state.session && state.admin)) {
            setStatus('No tienes permisos para subir fotos.', 'error');
            return;
          }
          const files = Array.from(elements.fileInput.files);
          if (!files.length) return;
          const lastPosition = state.photos.reduce((max, photo) => Math.max(max, Number(photo.position) || 0), -1);
          try {
            for (let index = 0; index < files.length; index++) {
              const file = files[index];
              const extension = file.name.includes('.') ? file.name.substring(file.name.lastIndexOf('.') + 1) : '';
              const sanitized = file.name.replace(/\s+/g, '-');
              const objectName = `${crypto.randomUUID()}-${sanitized}`;
              setStatus(`Subiendo ${index + 1} de ${files.length}...`);
              const { error: uploadError } = await supabase.storage
                .from('album')
                .upload(objectName, file, { upsert: false, contentType: file.type });
              if (uploadError) {
                setStatus(uploadError.message, 'error');
                continue;
              }
              const path = `album/${objectName}`;
              const defaultTitle = extension ? file.name.replace(new RegExp(`\\.${extension}$`, 'i'), '') : file.name;
              const { error: insertError } = await supabase.from('album_photos').insert({
                path,
                title: defaultTitle,
                position: lastPosition + 1 + index,
                user_id: state.session.user.id
              });
              if (insertError) setStatus(insertError.message, 'error');
            }
            elements.fileInput.value = '';
            updateUploadState();
            await refreshPhotos();
            setStatus('Subida completada.', 'success');
          } catch (error) {
            setStatus(error.message || 'No se pudieron subir las fotos.', 'error');
          }
        }

        async function checkIsAdmin() {
          try {
            const { data, error } = await supabase.rpc('is_album_admin');
            if (error) throw error;
            state.admin = Boolean(data);
            setStatus(
              state.admin ? 'Rol de administrador verificado.' : 'Tu cuenta tiene acceso limitado.',
              state.admin ? 'success' : 'info'
            );
          } catch (error) {
            state.admin = false;
            setStatus(error.message || 'No se pudo validar el rol del usuario.', 'error');
          } finally {
            updateAuthUI();
          }
        }

        async function handleSessionChange(session) {
          state.session = session;
          if (!session) {
            state.admin = false;
            setStatus('Sesión cerrada.', 'info');
          }
          updateAuthUI();
          if (session) await checkIsAdmin();
          await refreshPhotos(!state.photos.length);
        }

        async function checkSession() {
          try {
            const { data, error } = await supabase.auth.getSession();
            if (error) throw error;
            await handleSessionChange(data.session);
          } catch (error) {
            setStatus(error.message || 'No se pudo verificar la sesión.', 'error');
            await refreshPhotos(true);
          }
        }

        elements.loginGoogle.addEventListener('click', async () => {
          await supabase.auth.signInWithOAuth({
            provider: 'google',
            options: { redirectTo: window.location.href }
          });
        });

        elements.loginForm.addEventListener('submit', async event => {
          event.preventDefault();
          const formData = new FormData(event.target);
          try {
            const { error } = await supabase.auth.signInWithPassword({
              email: formData.get('email'),
              password: formData.get('password')
            });
            if (error) throw error;
            setStatus('Sesión iniciada correctamente.', 'success');
            event.target.reset();
          } catch (error) {
            setStatus(error.message || 'No se pudo iniciar sesión.', 'error');
          }
          await checkSession();
        });

        elements.logout.addEventListener('click', async () => {
          await supabase.auth.signOut();
          await handleSessionChange(null);
        });

        elements.fileInput.addEventListener('change', updateUploadState);
        elements.uploadButton.addEventListener('click', uploadPhotos);

        supabase.auth.onAuthStateChange(async (_event, session) => {
          await handleSessionChange(session);
        });

        updateAuthUI();
        checkSession();
      });
    </script>

  </body>
</html>
